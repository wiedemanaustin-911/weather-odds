<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Odds ‚Äî MVP</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121931;
      --text: #e8eefc;
      --muted: #a8b3cf;
      --accent: #7cc4ff;
      --ok: #8de38d;
      --warn: #ffd280;
      --err: #ff9aa2;
      --border: #233058;
      --elev: 0 10px 30px rgba(0,0,0,0.2);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 0%, #12193a 0%, var(--bg) 60%);
      color: var(--text);
    }
    .wrap { max-width: 900px; margin: 0 auto; padding: 28px 16px 60px; }
    header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
    header h1 { font-size: 22px; margin: 0; }
    header .tag { font-size: 12px; color: var(--muted); border: 1px solid var(--border); padding: 2px 8px; border-radius: 12px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.08)); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: var(--elev); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1.2fr 1fr; } }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 12px 12px; border: 1px solid var(--border); border-radius: 12px; background: #0f1530; color: var(--text); outline: none; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button { cursor: pointer; background: linear-gradient(180deg, #2b83ff, #1c60c2); color: white; border: none; padding: 12px 16px; border-radius: 12px; font-weight: 600; }
    button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .hint { color: var(--muted); font-size: 12px; }
    .results { margin-top: 16px; display: grid; gap: 12px; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .kpi { background: #0d1430; border: 1px solid var(--border); border-radius: 12px; padding: 14px; text-align: center; }
    .kpi h3 { margin: 0; font-size: 28px; }
    .kpi p { margin: 6px 0 0; color: var(--muted); font-size: 12px; }
    .years { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; line-height: 1.6; color: var(--muted); background: #0d1430; border: 1px dashed var(--border); border-radius: 12px; padding: 12px; max-height: 200px; overflow: auto; }
    .note { font-size: 12px; color: var(--muted); }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }

    /* Typeahead */
    .typeahead-wrap { position: relative; }
    .suggestions { position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: #0f1530; border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--elev); max-height: 250px; overflow: auto; z-index: 40; display: none; }
    .suggestions .item { display: flex; align-items: center; gap: 6px; padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
    .suggestions .item:hover { background: #12193a; }
    .suggestions .name { font-size: 14px; }
    .suggestions .meta { color: var(--muted); font-size: 12px; }

    /* Simple dot chart */
    .dot-chart { display: flex; flex-wrap: wrap; gap: 4px; }
    .dot { width: 14px; height: 14px; border-radius: 50%; background: #2a335a; border: 1px solid var(--border); }
    .dot.wet { background: var(--accent); }

    .alt-dates { font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üå¶Ô∏è Weather Odds ‚Äî Rain on a Specific Date</h1>
      <span class="tag">MVP</span>
    </header>

    <div class="grid">
      <section class="card">
        <h2 style="margin-top:0">1) Pick a place & date</h2>
        <label>Location (city, resort, venue)</label>
        <div class="typeahead-wrap">
          <input id="place" type="text" placeholder="e.g., Los Angeles, California" value="Snowbird, Utah" autocomplete="off" />
          <div id="suggestions" class="suggestions"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Month</label>
            <select id="month"></select>
          </div>
          <div>
            <label>Day</label>
            <select id="day"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Years Back</label>
            <input id="years" type="number" min="5" max="70" value="20" />
            <div class="hint">Uses the last N <em>complete</em> years.</div>
          </div>
          <div>
            <label>What counts as wet?</label>
            <select id="threshold">
              <option value="0">Any measurable rain or snow</option>
              <option value="0.1" selected>Measurable rain/snow (avoids trace)</option>
              <option value="1">At least a light amount</option>
              <option value="5">At least a moderate amount</option>
            </select>
            <div class="hint">We count a day as wet if it had measurable rain or snow (liquid water equivalent).</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label><input id="biasUS" type="checkbox" checked /> Prefer United States</label>
            <div class="hint">Helps when a place name exists in multiple countries.</div>
          </div>
          <div>
            <label><input id="biasUtah" type="checkbox" checked /> Prefer Utah</label>
            <div class="hint">If ambiguous (e.g., Alta), favor Utah matches.</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px">
          <button id="go">Check Odds</button>
          <button class="secondary" id="demo">Try Demo (Snowbird ‚Ä¢ Jul 25 ‚Ä¢ 20y)</button>
        </div>

        <p class="note" style="margin-top:12px">Powered by Open‚ÄëMeteo Historical Weather & Geocoding (free, no key). Results use daily aggregates and may differ from nearby station observations.</p>
      </section>

      <section class="card">
        <h2 style="margin-top:0">2) Result</h2>
        <div id="status" class="hint">Enter a location and hit <b>Check Odds</b>.</div>

        <div id="picker" style="display:none; margin:10px 0;">
          <label>Did you mean:</label>
          <div class="row">
            <select id="candidateSelect"></select>
            <button id="useCandidate">Use this location</button>
          </div>
          <div class="hint">Tip: You can type "Alta, Utah" or enable the Utah/US bias above.</div>
        </div>

        <div class="results" id="results" style="display:none">
          <div class="kpis">
            <div class="kpi">
              <h3 id="kpiCount">‚Äî</h3>
              <p>Wet Years</p>
            </div>
            <div class="kpi">
              <h3 id="kpiPct">‚Äî</h3>
              <p>Percent of Years</p>
            </div>
            <div class="kpi">
              <h3 id="kpiAvg">‚Äî</h3>
              <p>Avg on Wet Days</p>
            </div>
          </div>

          <div id="tempInfo" class="note"></div>
          <div id="dotChart" class="dot-chart"></div>
          <div id="altDates" class="alt-dates"></div>

          <div class="years" id="yearsList"></div>
          <div class="note">Wet = day had measurable rain or snow. Units show inches in parentheses.</div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h2 style="margin-top:0">About this MVP</h2>
      <p class="note">This tool fetches daily precipitation and temperatures for a range of years and counts how many target dates were wet. Data is from the Open‚ÄëMeteo Archive API (ERA5‚ÄëLand, 10 km grid).</p>
    </section>
  </div>

  <script>
    // ===== Populate month/day selects (keep original behavior) =====
    const monthSel = document.getElementById('month');
    const daySel = document.getElementById('day');
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    monthNames.forEach((m,i)=>{
      const opt = document.createElement('option');
      opt.value = String(i+1).padStart(2,'0');
      opt.textContent = `${opt.value} ‚Äî ${m}`;
      monthSel.appendChild(opt);
    });
    monthSel.value = '07';
    function repopulateDays() {
      const year = 2024; // any leap ref
      const month = parseInt(monthSel.value, 10)-1;
      const daysInMonth = new Date(year, month+1, 0).getDate();
      daySel.innerHTML = '';
      for (let d=1; d<=daysInMonth; d++) {
        const opt = document.createElement('option');
        opt.value = String(d).padStart(2,'0');
        opt.textContent = opt.value;
        daySel.appendChild(opt);
      }
      if (parseInt(monthSel.value,10) === 7) daySel.value = '25';
    }
    monthSel.addEventListener('change', repopulateDays);
    repopulateDays();

    // ===== Elements =====
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const yearsListEl = document.getElementById('yearsList');
    const kpiCount = document.getElementById('kpiCount');
    const kpiPct = document.getElementById('kpiPct');
    const kpiAvg = document.getElementById('kpiAvg');
    const tempInfoEl = document.getElementById('tempInfo');
    const dotChartEl = document.getElementById('dotChart');
    const altDatesEl = document.getElementById('altDates');

    const pickerEl = document.getElementById('picker');
    const candidateSelect = document.getElementById('candidateSelect');
    const useCandidateBtn = document.getElementById('useCandidate');

    const biasUS = document.getElementById('biasUS');
    const biasUtah = document.getElementById('biasUtah');

    const placeInput = document.getElementById('place');

    function mmToIn(mm) { return mm / 25.4; }
    function cToF(c) { return (c * 9/5) + 32; }

    // ===== Typeahead: search-as-you-type =====
    const suggestions = document.getElementById('suggestions');
    function clearSuggestions(){ suggestions.innerHTML=''; suggestions.style.display='none'; }
    function renderSuggestions(items){
      suggestions.innerHTML='';
      items.forEach((r)=>{
        const row = document.createElement('div');
        row.className='item';
        row.innerHTML = `<span class="name">${r.name}</span> <span class="meta">${[r.admin1, r.country].filter(Boolean).join(', ')}</span>`;
        row.onclick = ()=>{ placeInput.value = [r.name, r.admin1, r.country].filter(Boolean).join(', '); clearSuggestions(); };
        suggestions.appendChild(row);
      });
      suggestions.style.display = items.length ? 'block' : 'none';
    }
    let debounceTimer=null;
    placeInput.addEventListener('input', (e)=>{
      const raw = e.target.value.trim();
      clearTimeout(debounceTimer);
      if(!raw){ clearSuggestions(); return; }
      debounceTimer=setTimeout(async()=>{
        try{
          const list = await geocodeMulti(raw);
          renderSuggestions(list.slice(0,8));
        }catch(err){ clearSuggestions(); }
      }, 220);
    });
    document.addEventListener('click',(ev)=>{ if(!ev.target.closest('.typeahead-wrap')) clearSuggestions(); });

    // ===== Aliases for convenience =====
    const ALIASES = {
      'snowbird': 'Snowbird, Utah, USA',
      'snowbird, utah': 'Snowbird, Utah, USA',
      'alta': 'Alta, Utah, USA',
      'park city': 'Park City, Utah, USA',
      'deer valley': 'Deer Valley, Utah, USA'
    };

    async function geocodeMulti(query){
      const key = query.trim().toLowerCase();
      if (ALIASES[key]) query = ALIASES[key];
      async function fetchGeo(name){
        const url = new URL('https://geocoding-api.open-meteo.com/v1/search');
        url.searchParams.set('name', name);
        url.searchParams.set('count', '10');
        url.searchParams.set('language', 'en');
        const r = await fetch(url); if(!r.ok) return {results:[]};
        return r.json();
      }
      let {results} = await fetchGeo(query);
      if(!results || !results.length){
        const trials=[query+', Utah', query+', Utah, USA', query+' Ski Resort, Utah, USA'];
        for(const t of trials){ const d=await fetchGeo(t); if(d.results && d.results.length){ results=d.results; break; } }
      }
      // optional biases
      if (results && results.length){
        if (biasUS.checked) results = results.filter(r=>r.country_code==='US');
        if (biasUtah.checked){
          const ut = results.filter(r=> (r.admin1||'').toLowerCase().includes('utah'));
          if (ut.length) results = ut;
        }
      }
      return results || [];
    }

    function showCandidatePicker(list){
      candidateSelect.innerHTML='';
      list.forEach((r,idx)=>{
        const opt=document.createElement('option');
        opt.value=String(idx);
        opt.textContent=[r.name, r.admin1, r.country].filter(Boolean).join(', ')+`  (lat ${r.latitude.toFixed(3)}, lon ${r.longitude.toFixed(3)})`;
        candidateSelect.appendChild(opt);
      });
      pickerEl.style.display='block';
    }
    function hideCandidatePicker(){ pickerEl.style.display='none'; }

    function lastCompleteYears(n){ const endYear=new Date().getFullYear()-1; const startYear=endYear-(n-1); return {startYear,endYear}; }

    function buildArchiveURL(lat, lon, start, end){
      const url = new URL('https://archive-api.open-meteo.com/v1/archive');
      url.searchParams.set('latitude', lat);
      url.searchParams.set('longitude', lon);
      url.searchParams.set('start_date', start);
      url.searchParams.set('end_date', end);
      url.searchParams.set('daily', 'precipitation_sum,temperature_2m_max,temperature_2m_min');
      url.searchParams.set('timezone', 'auto');
      return url.toString();
    }

    async function run(query, month, day, nYears, thresholdMm){
      resultsEl.style.display='none';
      hideCandidatePicker();
      statusEl.textContent='Looking up coordinates‚Ä¶';
      try{
        const candidates = await geocodeMulti(query);
        if(!candidates || !candidates.length){ throw new Error('No matching location found. Try adding state/country (e.g., "Alta, Utah").'); }
        let chosen = candidates[0];
        if(candidates.length>1){
          showCandidatePicker(candidates);
          statusEl.textContent='Multiple locations found ‚Äî pick one.';
          await new Promise((resolve)=>{ useCandidateBtn.onclick=()=>{ const idx=parseInt(candidateSelect.value,10)||0; chosen=candidates[idx]; hideCandidatePicker(); resolve(); }; });
        }
        const loc = { lat: chosen.latitude, lon: chosen.longitude, name: [chosen.name, chosen.admin1, chosen.country].filter(Boolean).join(', ') };
        statusEl.textContent=`Using ${loc.name}. Fetching historical daily weather‚Ä¶`;

        const {startYear, endYear} = lastCompleteYears(nYears);
        const start = `${startYear}-${month}-01`;
        const end = `${endYear}-${month}-31`;
        const res = await fetch(buildArchiveURL(loc.lat, loc.lon, start, end));
        if(!res.ok) throw new Error('Archive API request failed');
        const data = await res.json();
        if(!data.daily || !data.daily.time) throw new Error('No daily data returned');

        const times = data.daily.time;
        const prec = data.daily.precipitation_sum; // mm
        const tmax = data.daily.temperature_2m_max; // ¬∞C
        const tmin = data.daily.temperature_2m_min; // ¬∞C

        const targetMD = `-${month}-${day}`;
        const prevDay = String(Math.max(1, parseInt(day,10)-1)).padStart(2,'0');
        const nextDay = String(parseInt(day,10)+1).padStart(2,'0');
        const mdPrev = `-${month}-${prevDay}`;
        const mdNext = `-${month}-${nextDay}`;

        const recs = []; // {year, mm, tmax, tmin}
        const recsPrev = [];
        const recsNext = [];
        for (let i=0;i<times.length;i++){
          const y = parseInt(times[i].slice(0,4),10);
          if (y < startYear || y > endYear) continue;
          const row = {year:y, mm: prec[i] ?? 0, tmax: tmax[i], tmin: tmin[i]};
          if (times[i].endsWith(targetMD)) recs.push(row);
          if (times[i].endsWith(mdPrev)) recsPrev.push(row);
          if (times[i].endsWith(mdNext)) recsNext.push(row);
        }
        if (!recs.length) throw new Error('No matching date records found.');

        // KPIs for target date
        const wet = recs.filter(r => (r.mm||0) >= thresholdMm);
        const count = wet.length; const total = recs.length; const pct = (count/total)*100;
        const avgOnWet = wet.length ? wet.reduce((a,b)=>a+(b.mm||0),0)/wet.length : 0;
        kpiCount.textContent = `${count} / ${total}`;
        kpiPct.textContent = `${pct.toFixed(0)}%`;
        kpiAvg.textContent = `${mmToIn(avgOnWet).toFixed(2)} in`;

        // Temperature context (avg high/low across all years for the date)
        const avgHighF = cToF(recs.reduce((a,b)=>a+(b.tmax||0),0)/recs.length);
        const avgLowF  = cToF(recs.reduce((a,b)=>a+(b.tmin||0),0)/recs.length);
        tempInfoEl.innerHTML = `üå°Ô∏è Typical temps on this date: <b>${avgHighF.toFixed(0)}¬∞F</b> / <b>${avgLowF.toFixed(0)}¬∞F</b> (historical average)`;

        // Dot chart (one dot per year)
        dotChartEl.innerHTML='';
        recs.sort((a,b)=>a.year-b.year).forEach(r=>{
          const dot=document.createElement('div');
          dot.className = 'dot' + ((r.mm||0) >= thresholdMm ? ' wet' : '');
          dot.title = `${r.year}: ${(mmToIn(r.mm||0)).toFixed(2)} in`;
          dotChartEl.appendChild(dot);
        });

        // Alternative date suggestions (prev/target/next)
        function pctWet(list){ if(!list.length) return null; const c=list.filter(r=> (r.mm||0)>=thresholdMm).length; return (c/list.length)*100; }
        const pPrev = pctWet(recsPrev);
        const pTgt  = pctWet(recs);
        const pNext = pctWet(recsNext);
        const parts=[];
        if(pPrev!==null) parts.push(`${month}/${prevDay}: ${pPrev.toFixed(0)}% wet`);
        parts.push(`${month}/${day}: ${pTgt.toFixed(0)}% wet`);
        if(pNext!==null) parts.push(`${month}/${nextDay}: ${pNext.toFixed(0)}% wet`);
        altDatesEl.innerHTML = `üìÖ Nearby dates: ${parts.join(' ‚Ä¢ ')}${(pPrev!==null && pNext!==null)?` ‚Äî try ${Math.min(pPrev,pNext,pTgt)===pPrev?month+'/'+prevDay:(Math.min(pPrev,pNext,pTgt)===pNext?month+'/'+nextDay:month+'/'+day)} for drier odds.`:''}`;

        // Years list (keep original output style)
        const lines = recs.map(r=>{
          const mark = ((r.mm||0) >= thresholdMm) ? '‚òî' : '¬∑';
          return `${mark} ${r.year}: ${(r.mm||0).toFixed(2)} mm (${mmToIn(r.mm||0).toFixed(2)} in)`;
        });
        yearsListEl.textContent = lines.join('\n');

        statusEl.innerHTML = `<span class="ok">Done:</span> ${loc.name} ‚Ä¢ ${month}/${day} ‚Ä¢ ${startYear}‚Äì${endYear}`;
        resultsEl.style.display='grid';
      }catch(err){
        statusEl.innerHTML = `<span class="err">${err.message}</span>`;
        resultsEl.style.display='none';
      }
    }

    // ===== Buttons =====
    document.getElementById('go').addEventListener('click', ()=>{
      const q = document.getElementById('place').value.trim();
      const m = monthSel.value; const d = daySel.value;
      const n = Math.max(5, Math.min(70, parseInt(document.getElementById('years').value, 10) || 20));
      const threshold = parseFloat(document.getElementById('threshold').value);
      run(q,m,d,n,threshold);
    });
    document.getElementById('demo').addEventListener('click', ()=>{
      document.getElementById('place').value = 'Snowbird';
      monthSel.value='07'; repopulateDays(); daySel.value='25';
      document.getElementById('years').value='20';
      document.getElementById('threshold').value='0.1';
      document.getElementById('go').click();
    });
  </script>
</body>
</html>

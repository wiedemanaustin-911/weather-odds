<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Odds ‚Äî MVP</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121931;
      --text: #e8eefc;
      --muted: #a8b3cf;
      --accent: #7cc4ff;
      --ok: #8de38d;
      --warn: #ffd280;
      --err: #ff9aa2;
      --border: #233058;
      --elev: 0 10px 30px rgba(0,0,0,0.2);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 0%, #12193a 0%, var(--bg) 60%);
      color: var(--text);
    }
    .wrap { max-width: 900px; margin: 0 auto; padding: 28px 16px 60px; }
    header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
    header h1 { font-size: 22px; margin: 0; }
    header .tag { font-size: 12px; color: var(--muted); border: 1px solid var(--border); padding: 2px 8px; border-radius: 12px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.08)); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: var(--elev); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1.2fr 1fr; } }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 12px 12px; border: 1px solid var(--border); border-radius: 12px; background: #0f1530; color: var(--text); outline: none; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button { cursor: pointer; background: linear-gradient(180deg, #2b83ff, #1c60c2); color: white; border: none; padding: 12px 16px; border-radius: 12px; font-weight: 600; }
    button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .hint { color: var(--muted); font-size: 12px; }
    .results { margin-top: 16px; display: grid; gap: 10px; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .kpi { background: #0d1430; border: 1px solid var(--border); border-radius: 12px; padding: 14px; text-align: center; }
    .kpi h3 { margin: 0; font-size: 28px; }
    .kpi p { margin: 6px 0 0; color: var(--muted); font-size: 12px; }
    .years { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; line-height: 1.6; color: var(--muted); background: #0d1430; border: 1px dashed var(--border); border-radius: 12px; padding: 12px; max-height: 200px; overflow: auto; }
    .note { font-size: 12px; color: var(--muted); }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }

    /* Typeahead */
    .typeahead-wrap { position: relative; }
    .suggestions {
      position: absolute; top: calc(100% + 6px); left: 0; right: 0;
      background: #0f1530; border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--elev);
      max-height: 220px; overflow: auto; z-index: 40; display: none;
    }
    .suggestions button { width: 100%; text-align: left; background: transparent; border: none; color: var(--text); padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.04); }
    .suggestions button:hover, .suggestions button:focus { background: #12193a; }
    .suggestions .meta { color: var(--muted); font-size: 12px; margin-left: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üå¶Ô∏è Weather Odds ‚Äî Rain on a Specific Date</h1>
      <span class="tag">MVP</span>
    </header>

    <div class="grid">
      <section class="card">
        <h2 style="margin-top:0">1) Pick a place & date</h2>
        <label>Location (city, resort, venue)</label>
        <div class="typeahead-wrap">
          <input id="place" type="text" placeholder="e.g., Snowbird, Utah" value="Snowbird, Utah" autocomplete="off" />
          <div id="suggestions" class="suggestions"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Month</label>
            <select id="month"></select>
          </div>
          <div>
            <label>Day</label>
            <select id="day"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Years Back</label>
            <input id="years" type="number" min="5" max="70" value="20" />
            <div class="hint">Uses the last N <em>complete</em> years.</div>
          </div>
          <div>
            <label>What counts as precipitation?</label>
            <input id="threshold" type="hidden" value="0.1" />
            <div class="hint">Counts <b>any rain or snow</b> with liquid equivalent ‚â• <b>0.1 mm</b>. (Simple, clear: ‚ÄúWas there precip or not?‚Äù)</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px">
          <button id="go">Check Odds</button>
          <button class="secondary" id="demo">Try Demo (Snowbird ‚Ä¢ Jul 25 ‚Ä¢ 20y)</button>
        </div>

        <p class="note" style="margin-top:12px">Powered by Open‚ÄëMeteo Historical Weather & Geocoding (free, no key). We use <b>daily precipitation (rain + snow water equivalent)</b> from ERA5‚ÄëLand.</p>
      </section>

      <section class="card">
        <h2 style="margin-top:0">2) Result</h2>
        <div id="status" class="hint">Enter a location and hit <b>Check Odds</b>.</div>

        <div id="picker" style="display:none; margin:10px 0;">
          <label>Did you mean:</label>
          <div class="row">
            <select id="candidateSelect"></select>
            <button id="useCandidate">Use this location</button>
          </div>
        </div>

        <div class="results" id="results" style="display:none">
          <div class="kpis">
            <div class="kpi">
              <h3 id="kpiCount">‚Äî</h3>
              <p>Rain/Snow Years</p>
            </div>
            <div class="kpi">
              <h3 id="kpiPct">‚Äî</h3>
              <p>Percent of Years</p>
            </div>
            <div class="kpi">
              <h3 id="kpiAvg">‚Äî</h3>
              <p>Avg on Wet Years</p>
            </div>
          </div>

          <div class="years" id="yearsList"></div>
          <div class="note">We mark a year as ‚Äúwet‚Äù if precipitation (rain or snow water equivalent) ‚â• 0.1 mm on the chosen date.</div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h2 style="margin-top:0">About this MVP</h2>
      <p class="note">This tool fetches daily precipitation for a range of years and counts how many target dates met the threshold. Data is from the Open‚ÄëMeteo Archive API (ERA5‚ÄëLand, 10 km grid). For exact station observations (e.g., SNOTEL), you can integrate those later.</p>
    </section>
  </div>

  <script>
    // ===== Month/Day Selectors (Month names instead of numbers) =====
    const monthSel = document.getElementById('month');
    const daySel = document.getElementById('day');
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    monthNames.forEach((m,i)=>{
      const opt = document.createElement('option');
      // store 01..12 in value, but show full month name
      opt.value = String(i+1).padStart(2,'0');
      opt.textContent = m;
      monthSel.appendChild(opt);
    });
    monthSel.value = '07';

    function repopulateDays() {
      const year = 2024; // leap-safe calendar reference
      const month = parseInt(monthSel.value, 10)-1;
      const daysInMonth = new Date(year, month+1, 0).getDate();
      daySel.innerHTML = '';
      for (let d=1; d<=daysInMonth; d++) {
        const opt = document.createElement('option');
        opt.value = String(d).padStart(2,'0');
        opt.textContent = String(d);
        daySel.appendChild(opt);
      }
      if (parseInt(monthSel.value,10) === 7) daySel.value = '25';
    }
    monthSel.addEventListener('change', repopulateDays);
    repopulateDays();

    // ===== Elements =====
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const yearsListEl = document.getElementById('yearsList');
    const kpiCount = document.getElementById('kpiCount');
    const kpiPct = document.getElementById('kpiPct');
    const kpiAvg = document.getElementById('kpiAvg');

    const pickerEl = document.getElementById('picker');
    const candidateSelect = document.getElementById('candidateSelect');
    const useCandidateBtn = document.getElementById('useCandidate');

    const placeInput = document.getElementById('place');
    const suggestions = document.getElementById('suggestions');

    function mmToIn(mm) { return mm / 25.4; }

    // Simple aliases for well-known Utah ski areas
    const ALIASES = {
      'snowbird': 'Snowbird, Utah, USA',
      'alta': 'Alta, Utah, USA',
      'park city': 'Park City, Utah, USA',
      'deer valley': 'Deer Valley, Utah, USA'
    };

    // Keep a selected location (lat/lon) when user picks from suggestions
    let selectedLoc = null; // {lat, lon, name}

    // ===== Geocoding Helpers =====
    async function geocodeQuery(name, count=5) {
      const url = new URL('https://geocoding-api.open-meteo.com/v1/search');
      url.searchParams.set('name', name);
      url.searchParams.set('count', String(count));
      url.searchParams.set('language', 'en');
      const res = await fetch(url);
      if (!res.ok) throw new Error('Geocoding failed');
      const data = await res.json();
      return data.results || [];
    }

    function asLabel(r) {
      return [r.name, r.admin1, r.country].filter(Boolean).join(', ');
    }

    function showCandidatePicker(list) {
      candidateSelect.innerHTML = '';
      list.forEach((r, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = asLabel(r);
        candidateSelect.appendChild(opt);
      });
      pickerEl.style.display = 'block';
    }
    function hideCandidatePicker() { pickerEl.style.display = 'none'; }

    // ===== Typeahead (search-as-you-type) =====
    function clearSuggestions() { suggestions.innerHTML = ''; suggestions.style.display = 'none'; }
    function renderSuggestions(items) {
      suggestions.innerHTML = '';
      items.forEach((r) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.innerHTML = `${r.name} <span class="meta">${[r.admin1, r.country].filter(Boolean).join(', ')}</span>`;
        btn.onclick = () => {
          selectedLoc = { lat: r.latitude, lon: r.longitude, name: asLabel(r) };
          placeInput.value = selectedLoc.name;
          clearSuggestions();
        };
        suggestions.appendChild(btn);
      });
      suggestions.style.display = items.length ? 'block' : 'none';
    }

    let debounceTimer = null;
    placeInput.addEventListener('input', async (e) => {
      const q = e.target.value.trim();
      selectedLoc = null; // typing cancels prior selection
      if (!q) { clearSuggestions(); return; }

      const key = q.toLowerCase();
      if (ALIASES[key]) {
        // snap to alias immediately
        placeInput.value = ALIASES[key];
      }

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        try {
          const results = await geocodeQuery(placeInput.value, 6);
          renderSuggestions(results);
        } catch(err) { clearSuggestions(); }
      }, 250);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', (ev) => {
      if (!ev.target.closest('.typeahead-wrap')) clearSuggestions();
    });

    function buildArchiveURL(lat, lon, start, end) {
      const url = new URL('https://archive-api.open-meteo.com/v1/archive');
      url.searchParams.set('latitude', lat);
      url.searchParams.set('longitude', lon);
      url.searchParams.set('start_date', start);
      url.searchParams.set('end_date', end);
      url.searchParams.set('daily', 'precipitation_sum');
      url.searchParams.set('timezone', 'auto');
      return url.toString();
    }

    function lastCompleteYears(n) {
      const endYear = new Date().getFullYear() - 1; // exclude partial current year
      const startYear = endYear - (n - 1);
      return { startYear, endYear };
    }

    async function run(query, month, day, nYears, thresholdMm) {
      resultsEl.style.display = 'none';
      hideCandidatePicker();
      clearSuggestions();
      statusEl.textContent = 'Resolving location‚Ä¶';
      try {
        let loc = selectedLoc;
        if (!loc) {
          // If no selection from typeahead, try alias or direct geocode; offer picker if many
          let q = query.trim();
          const key = q.toLowerCase();
          if (ALIASES[key]) q = ALIASES[key];
          const candidates = await geocodeQuery(q, 6);
          if (!candidates || candidates.length === 0) throw new Error('No matching location found. Try adding state/country.');
          if (candidates.length === 1) {
            const r = candidates[0];
            loc = { lat: r.latitude, lon: r.longitude, name: asLabel(r) };
          } else {
            showCandidatePicker(candidates);
            statusEl.textContent = 'Multiple locations found ‚Äî pick one.';
            await new Promise((resolve) => {
              useCandidateBtn.onclick = () => {
                const idx = parseInt(candidateSelect.value, 10) || 0;
                const chosen = candidates[idx];
                loc = { lat: chosen.latitude, lon: chosen.longitude, name: asLabel(chosen) };
                hideCandidatePicker();
                resolve();
              };
            });
          }
        }

        statusEl.textContent = `Using ${loc.name}. Fetching historical daily precipitation‚Ä¶`;

        const { startYear, endYear } = lastCompleteYears(nYears);
        const start = `${startYear}-${month}-01`;
        const end = `${endYear}-${month}-31`;
        const url = buildArchiveURL(loc.lat, loc.lon, start, end);

        const res = await fetch(url);
        if (!res.ok) throw new Error('Archive API request failed');
        const data = await res.json();
        if (!data.daily || !data.daily.time) throw new Error('No daily data returned');

        const times = data.daily.time;
        const prec = data.daily.precipitation_sum;

        const targetMD = `-${month}-${day}`;
        const records = [];
        for (let i=0; i<times.length; i++) {
          if (times[i].endsWith(targetMD)) {
            const y = parseInt(times[i].slice(0,4), 10);
            if (y >= startYear && y <= endYear) {
              records.push({ year: y, mm: prec[i] ?? 0 });
            }
          }
        }

        if (records.length === 0) throw new Error('No matching date records found.');

        const rainy = records.filter(r => (r.mm || 0) >= thresholdMm);
        const count = rainy.length;
        const pct = (count / records.length) * 100;
        const avgOnRainy = rainy.length ? (rainy.reduce((a,b)=>a+b.mm,0) / rainy.length) : 0;

        kpiCount.textContent = `${count} / ${records.length}`;
        kpiPct.textContent = `${pct.toFixed(0)}%`;
        kpiAvg.textContent = `${avgOnRainy.toFixed(2)} mm (${mmToIn(avgOnRainy).toFixed(2)} in)`;

        const lines = records.map(r => {
          const mark = (r.mm >= thresholdMm) ? '‚òî' : '¬∑';
          const ins = mmToIn(r.mm).toFixed(2);
          const mm = r.mm.toFixed(2);
          return `${mark} ${r.year}: ${mm} mm (${ins} in)`;
        });
        yearsListEl.textContent = lines.join('\n');

        // A simple, human verdict for the user
        let verdict = 'Dry likely';
        if (pct >= 50) verdict = 'Precip likely';
        else if (pct >= 25) verdict = 'Precip possible';
        statusEl.innerHTML = `<span class="ok">${verdict}:</span> ${loc.name} ‚Ä¢ ${monthNames[parseInt(month,10)-1]} ${parseInt(day,10)} ‚Ä¢ ${startYear}‚Äì${endYear}`;
        resultsEl.style.display = 'grid';
      } catch (err) {
        statusEl.innerHTML = `<span class="err">${err.message}</span>`;
        resultsEl.style.display = 'none';
      }
    }

    document.getElementById('go').addEventListener('click', () => {
      const q = placeInput.value.trim();
      const m = monthSel.value;
      const d = daySel.value;
      const n = Math.max(5, Math.min(70, parseInt(document.getElementById('years').value, 10) || 20));
      const threshold = parseFloat(document.getElementById('threshold').value || '0.1');
      run(q, m, d, n, threshold);
    });

    document.getElementById('demo').addEventListener('click', () => {
      placeInput.value = 'Snowbird, Utah';
      selectedLoc = null;
      monthSel.value = '07'; repopulateDays(); daySel.value = '25';
      document.getElementById('years').value = '20';
      document.getElementById('threshold').value = '0.1';
      document.getElementById('go').click();
    });
  </script>
</body>
</html>


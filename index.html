<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Odds ‚Äî MVP</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121931;
      --text: #e8eefc;
      --muted: #a8b3cf;
      --accent: #7cc4ff;
      --ok: #8de38d;
      --warn: #ffd280;
      --err: #ff9aa2;
      --border: #233058;
      --elev: 0 10px 30px rgba(0,0,0,0.2);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: radial-gradient(1200px 600px at 10% 0%, #12193a 0%, var(--bg) 60%); color: var(--text); }
    .wrap { max-width: 900px; margin: 0 auto; padding: 28px 16px 60px; }
    header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
    header h1 { font-size: 22px; margin: 0; }
    header .tag { font-size: 12px; color: var(--muted); border: 1px solid var(--border); padding: 2px 8px; border-radius: 12px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.08)); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: var(--elev); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1.2fr 1fr; } }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 12px 12px; border: 1px solid var(--border); border-radius: 12px; background: #0f1530; color: var(--text); outline: none; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button { cursor: pointer; background: linear-gradient(180deg, #2b83ff, #1c60c2); color: white; border: none; padding: 12px 16px; border-radius: 12px; font-weight: 600; }
    .hint { color: var(--muted); font-size: 12px; }
    .results { margin-top: 16px; display: grid; gap: 10px; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .kpi { background: #0d1430; border: 1px solid var(--border); border-radius: 12px; padding: 14px; text-align: center; }
    .kpi h3 { margin: 0; font-size: 28px; }
    .kpi p { margin: 6px 0 0; color: var(--muted); font-size: 12px; }
    .note { font-size: 12px; color: var(--muted); }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }

    /* Typeahead */
    .typeahead-wrap { position: relative; }
    .suggestions { position: absolute; top: calc(100% + 6px); left: 0; right: 0; background: #0f1530; border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--elev); max-height: 220px; overflow: auto; z-index: 40; display: none; }
    .suggestions .item { display: flex; align-items: center; gap: 6px; padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.04); cursor: pointer; }
    .suggestions .item:hover { background: #12193a; }
    .suggestions .name { font-size: 14px; }
    .suggestions .meta { color: var(--muted); font-size: 12px; }

    .big-verdict { font-size: 20px; font-weight: 700; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üå¶Ô∏è Weather Odds ‚Äî Rain on a Specific Date</h1>
      <span class="tag">MVP</span>
    </header>

    <div class="grid">
      <section class="card">
        <h2 style="margin-top:0">1) Pick a place & date</h2>
        <label>Location (city, resort, venue)</label>
        <div class="typeahead-wrap">
          <input id="place" type="text" placeholder="e.g., Snowbird, Utah" value="Snowbird, Utah" autocomplete="off" />
          <div id="suggestions" class="suggestions"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Month</label>
            <select id="month"></select>
          </div>
          <div>
            <label>Day</label>
            <select id="day"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Years Back</label>
            <input id="years" type="number" min="5" max="70" value="20" />
            <div class="hint">Uses the last N <em>complete</em> years.</div>
          </div>
          <div>
            <label>What counts as precipitation?</label>
            <input id="threshold" type="hidden" value="0.1" />
            <div class="hint">We mark the day ‚Äúwet‚Äù if <b>rain or snow (liquid)</b> ‚â• <b>0.1 mm</b>.</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px">
          <button id="go">Check Odds</button>
        </div>

        <p class="note" style="margin-top:12px">Powered by Open‚ÄëMeteo Historical Weather & Geocoding (free, no key). We use <b>daily precipitation (rain + snow water equivalent)</b> from ERA5‚ÄëLand.</p>
      </section>

      <section class="card">
        <h2 style="margin-top:0">Will it Rain?</h2>
        <div id="status" class="hint">Enter a location and hit <b>Check Odds</b>.</div>

        <div id="picker" style="display:none; margin:10px 0;">
          <label>Did you mean:</label>
          <div class="row">
            <select id="candidateSelect"></select>
            <button id="useCandidate">Use this location</button>
          </div>
        </div>

        <div id="bigVerdict" class="big-verdict" style="display:none">‚Äî</div>

        <div class="results" id="results" style="display:none">
          <div class="kpis">
            <div class="kpi">
              <h3 id="kpiCount">‚Äî</h3>
              <p>Rain/Snow Years</p>
            </div>
            <div class="kpi">
              <h3 id="kpiPct">‚Äî</h3>
              <p>Percent of Years</p>
            </div>
            <div class="kpi">
              <h3 id="kpiAvg">‚Äî</h3>
              <p>Avg on Wet Years</p>
            </div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h2 style="margin-top:0">About this MVP</h2>
      <p class="note">This tool fetches daily precipitation for a range of years and counts how many target dates met the threshold. Data is from the Open‚ÄëMeteo Archive API (ERA5‚ÄëLand, 10 km grid). For exact station observations, you can layer SNOTEL/Meteostat later.</p>
    </section>
  </div>

  <script>
    // ===== Month/Day Selectors =====
    const monthSel = document.getElementById('month');
    const daySel = document.getElementById('day');
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    function populateMonths() {
      monthSel.innerHTML = '';
      monthNames.forEach((m,i)=>{
        const opt = document.createElement('option');
        opt.value = String(i+1).padStart(2,'0');
        opt.textContent = m;
        monthSel.appendChild(opt);
      });
      monthSel.value = '07';
    }
    function repopulateDays() {
      const year = 2024; // leap-safe reference
      const month = parseInt(monthSel.value, 10)-1;
      const daysInMonth = new Date(year, month+1, 0).getDate();
      daySel.innerHTML = '';
      for (let d=1; d<=daysInMonth; d++) {
        const opt = document.createElement('option');
        opt.value = String(d).padStart(2,'0');
        opt.textContent = String(d);
        daySel.appendChild(opt);
      }
      if (parseInt(monthSel.value,10) === 7) daySel.value = '25';
    }
    populateMonths();
    repopulateDays();
    monthSel.addEventListener('change', repopulateDays);

    // ===== Elements =====
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const kpiCount = document.getElementById('kpiCount');
    const kpiPct = document.getElementById('kpiPct');
    const kpiAvg = document.getElementById('kpiAvg');
    const bigVerdictEl = document.getElementById('bigVerdict');

    const pickerEl = document.getElementById('picker');
    const candidateSelect = document.getElementById('candidateSelect');
    const useCandidateBtn = document.getElementById('useCandidate');

    const placeInput = document.getElementById('place');
    const suggestions = document.getElementById('suggestions');

    function mmToIn(mm) { return mm / 25.4; }

    // ===== Aliases & Fallback Coordinates =====
    const ALIASES = {
      'snowbird': 'Snowbird, Utah, USA',
      'alta': 'Alta, Utah, USA',
      'park city': 'Park City, Utah, USA',
      'deer valley': 'Deer Valley, Utah, USA'
    };
    const FALLBACK_COORDS = {
      'snowbird, utah, usa': { lat: 40.582, lon: -111.657, name: 'Snowbird, Utah, USA' },
      'alta, utah, usa':     { lat: 40.588, lon: -111.637, name: 'Alta, Utah, USA' }
    };

    let selectedLoc = null; // {lat, lon, name}

    // ===== Geocoding helpers =====
    async function geocodeQuery(name, count=6) {
      const url = new URL('https://geocoding-api.open-meteo.com/v1/search');
      url.searchParams.set('name', name);
      url.searchParams.set('count', String(count));
      url.searchParams.set('language', 'en');
      const res = await fetch(url);
      if (!res.ok) throw new Error('Geocoding failed');
      const data = await res.json();
      return data.results || [];
    }
    async function resolveCandidates(input) {
      let q = input.trim();
      const key = q.toLowerCase();
      const tries = [];
      if (ALIASES[key]) tries.push(ALIASES[key]);
      tries.push(q);
      if (!/,/.test(q)) {
        tries.push(q + ', Utah');
        tries.push(q + ', Utah, USA');
        tries.push(q + ', United States');
        tries.push(q + ' Ski Resort, Utah, USA');
      }
      const uniq = [...new Set(tries)];
      for (const t of uniq) {
        const res = await geocodeQuery(t, 8);
        if (res.length) return res;
      }
      const fb = FALLBACK_COORDS[(ALIASES[key] || q).toLowerCase()];
      if (fb) {
        return [{ name: fb.name.split(',')[0], admin1: 'Utah', country: 'United States', latitude: fb.lat, longitude: fb.lon }];
      }
      return [];
    }
    function asLabel(r) { return [r.name, r.admin1, r.country].filter(Boolean).join(', '); }

    // ===== Typeahead =====
    function clearSuggestions() { suggestions.innerHTML = ''; suggestions.style.display = 'none'; }
    function renderSuggestions(items) {
      suggestions.innerHTML = '';
      items.forEach((r) => {
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `<span class="name">${r.name}</span> <span class="meta">${[r.admin1, r.country].filter(Boolean).join(', ')}</span>`;
        row.onclick = () => { selectedLoc = { lat: r.latitude, lon: r.longitude, name: asLabel(r) }; placeInput.value = selectedLoc.name; clearSuggestions(); };
        suggestions.appendChild(row);
      });
      suggestions.style.display = items.length ? 'block' : 'none';
    }
    let debounceTimer = null;
    placeInput.addEventListener('input', (e) => {
      const raw = e.target.value.trim();
      selectedLoc = null;
      if (!raw) { clearSuggestions(); return; }
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        try { renderSuggestions(await resolveCandidates(raw)); } catch(err) { clearSuggestions(); }
      }, 250);
    });
    document.addEventListener('click', (ev) => { if (!ev.target.closest('.typeahead-wrap')) clearSuggestions(); });

    // ===== Data fetch & compute =====
    function buildArchiveURL(lat, lon, start, end) {
      const url = new URL('https://archive-api.open-meteo.com/v1/archive');
      url.searchParams.set('latitude', lat);
      url.searchParams.set('longitude', lon);
      url.searchParams.set('start_date', start);
      url.searchParams.set('end_date', end);
      url.searchParams.set('daily', 'precipitation_sum');
      url.searchParams.set('timezone', 'auto');
      return url.toString();
    }
    function lastCompleteYears(n) { const endYear = new Date().getFullYear() - 1; const startYear = endYear - (n - 1); return { startYear, endYear }; }

    async function run(query, month, day, nYears, thresholdMm) {
      resultsEl.style.display = 'none';
      bigVerdictEl.style.display = 'none';
      clearSuggestions();
      statusEl.textContent = 'Resolving location‚Ä¶';
      try {
        let loc = selectedLoc;
        if (!loc) {
          const candidates = await resolveCandidates(query);
          if (!candidates || !candidates.length) throw new Error('No matching location found. Try adding state/country.');
          if (candidates.length === 1) { const r = candidates[0]; loc = { lat: r.latitude, lon: r.longitude, name: asLabel(r) }; }
          else {
            const select = document.getElementById('candidateSelect'); select.innerHTML = '';
            candidates.forEach((r, idx) => { const opt = document.createElement('option'); opt.value = String(idx); opt.textContent = asLabel(r); select.appendChild(opt); });
            pickerEl.style.display = 'block'; statusEl.textContent = 'Multiple locations found ‚Äî pick one.';
            await new Promise((resolve) => { useCandidateBtn.onclick = () => { const idx = parseInt(select.value, 10) || 0; const c = candidates[idx]; loc = { lat: c.latitude, lon: c.longitude, name: asLabel(c) }; pickerEl.style.display = 'none'; resolve(); }; });
          }
        }

        statusEl.textContent = `Using ${loc.name}. Fetching historical daily precipitation‚Ä¶`;
        const { startYear, endYear } = lastCompleteYears(nYears);
        const start = `${startYear}-${month}-01`; const end = `${endYear}-${month}-31`;
        const res = await fetch(buildArchiveURL(loc.lat, loc.lon, start, end)); if (!res.ok) throw new Error('Archive API request failed');
        const data = await res.json(); if (!data.daily || !data.daily.time) throw new Error('No daily data returned');

        const times = data.daily.time; const prec = data.daily.precipitation_sum; const targetMD = `-${month}-${day}`; const records = [];
        for (let i=0; i<times.length; i++) { if (times[i].endsWith(targetMD)) { const y = parseInt(times[i].slice(0,4),10); if (y >= startYear && y <= endYear) { records.push({ year: y, mm: prec[i] ?? 0 }); } } }
        if (records.length === 0) throw new Error('No matching date records found.');

        const rainy = records.filter(r => (r.mm || 0) >= thresholdMm);
        const count = rainy.length; const pct = (count / records.length) * 100; const avgOnRainy = rainy.length ? (rainy.reduce((a,b)=>a+b.mm,0) / rainy.length) : 0;

        // KPIs (inches only for avg)
        kpiCount.textContent = `${count} / ${records.length}`;
        kpiPct.textContent = `${pct.toFixed(0)}%`;
        const avgIn = mmToIn(avgOnRainy); kpiAvg.textContent = `${avgIn.toFixed(2)} in`;

        // Big verdict line
        let verdictWord = 'Dry likely'; let icon = 'üå§Ô∏è';
        if (pct >= 50) { verdictWord = 'Precip likely'; icon = 'üåßÔ∏è'; }
        else if (pct >= 25) { verdictWord = 'Precip possible'; icon = 'üå¶Ô∏è'; }
        bigVerdictEl.textContent = `${icon} ${verdictWord}: ${loc.name} ‚Äî ${monthNames[parseInt(month,10)-1]} ${parseInt(day,10)} (${records.length}-year history)`;
        bigVerdictEl.style.display = 'block';

        statusEl.innerHTML = `<span class="ok">Done.</span>`;
        resultsEl.style.display = 'grid';
      } catch (err) {
        statusEl.innerHTML = `<span class="err">${err.message}</span>`;
        resultsEl.style.display = 'none'; bigVerdictEl.style.display = 'none';
      }
    }

    // ===== Handlers =====
    document.getElementById('go').addEventListener('click', () => {
      const q = placeInput.value.trim();
      const m = monthSel.value; const d = daySel.value; const n = Math.max(5, Math.min(70, parseInt(document.getElementById('years').value, 10) || 20));
      const threshold = parseFloat(document.getElementById('threshold').value || '0.1');
      run(q, m, d, n, threshold);
    });
  </script>
</body>
</html>


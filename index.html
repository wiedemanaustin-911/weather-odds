<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather Odds ‚Äî MVP</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #121931;
      --text: #e8eefc;
      --muted: #a8b3cf;
      --accent: #7cc4ff;
      --ok: #8de38d;
      --warn: #ffd280;
      --err: #ff9aa2;
      --border: #233058;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 10% 0%, #12193a 0%, var(--bg) 60%);
      color: var(--text);
    }
    .wrap { max-width: 900px; margin: 0 auto; padding: 28px 16px 60px; }
    header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
    header h1 { font-size: 22px; margin: 0; }
    header .tag { font-size: 12px; color: var(--muted); border: 1px solid var(--border); padding: 2px 8px; border-radius: 12px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.08)); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1.2fr 1fr; } }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 12px 12px; border: 1px solid var(--border); border-radius: 12px; background: #0f1530; color: var(--text); outline: none; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button { cursor: pointer; background: linear-gradient(180deg, #2b83ff, #1c60c2); color: white; border: none; padding: 12px 16px; border-radius: 12px; font-weight: 600; }
    button.secondary { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .hint { color: var(--muted); font-size: 12px; }
    .results { margin-top: 16px; display: grid; gap: 10px; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .kpi { background: #0d1430; border: 1px solid var(--border); border-radius: 12px; padding: 14px; text-align: center; }
    .kpi h3 { margin: 0; font-size: 28px; }
    .kpi p { margin: 6px 0 0; color: var(--muted); font-size: 12px; }
    .years { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; line-height: 1.6; color: var(--muted); background: #0d1430; border: 1px dashed var(--border); border-radius: 12px; padding: 12px; max-height: 200px; overflow: auto; }
    .note { font-size: 12px; color: var(--muted); }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üå¶Ô∏è Weather Odds ‚Äî Rain on a Specific Date</h1>
      <span class="tag">MVP</span>
    </header>

    <div class="grid">
      <section class="card">
        <h2 style="margin-top:0">1) Pick a place & date</h2>
        <label>Location (city, resort, venue)</label>
        <input id="place" type="text" placeholder="e.g., Snowbird, Utah" value="Snowbird, Utah" />

        <div class="row" style="margin-top:10px">
          <div>
            <label>Month</label>
            <select id="month"></select>
          </div>
          <div>
            <label>Day</label>
            <select id="day"></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Years Back</label>
            <input id="years" type="number" min="5" max="70" value="20" />
            <div class="hint">Uses the last N <em>complete</em> years.</div>
          </div>
          <div>
            <label>Rain Threshold</label>
            <select id="threshold">
              <option value="0">> 0.00 mm (any measurable)</option>
              <option value="0.1" selected>> 0.10 mm (avoid trace)</option>
              <option value="1">> 1.00 mm (light)</option>
              <option value="5">> 5.00 mm (moderate)</option>
            </select>
            <div class="hint">Daily precipitation (rain + snow water equivalent)</div>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label><input id="biasUS" type="checkbox" checked /> Prefer United States</label>
            <div class="hint">Filters geocoding results to US when possible.</div>
          </div>
          <div>
            <label><input id="biasUtah" type="checkbox" checked /> Prefer Utah</label>
            <div class="hint">If ambiguous (e.g., Alta), prefer Utah matches.</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px">
          <button id="go">Check Odds</button>
          <button class="secondary" id="demo">Try Demo (Snowbird ‚Ä¢ Jul 25 ‚Ä¢ 20y)</button>
        </div>

        <p class="note" style="margin-top:12px">Powered by Open‚ÄëMeteo Historical Weather & Geocoding (free, no key). Results use daily aggregates and may differ from nearby station observations.</p>
      </section>

      <section class="card">
        <h2 style="margin-top:0">2) Result</h2>
        <div id="status" class="hint">Enter a location and hit <b>Check Odds</b>.</div>

        <div id="picker" style="display:none; margin:10px 0;">
          <label>Did you mean:</label>
          <div class="row">
            <select id="candidateSelect"></select>
            <button id="useCandidate">Use this location</button>
          </div>
          <div class="hint">Tip: You can type "Alta, Utah" or enable the Utah/US bias above.</div>
        </div>

        <div class="results" id="results" style="display:none">
          <div class="kpis">
            <div class="kpi">
              <h3 id="kpiCount">‚Äî</h3>
              <p>Rainy Years</p>
            </div>
            <div class="kpi">
              <h3 id="kpiPct">‚Äî</h3>
              <p>Percent of Years</p>
            </div>
            <div class="kpi">
              <h3 id="kpiAvg">‚Äî</h3>
              <p>Avg on Rainy Years</p>
            </div>
          </div>

          <div class="years" id="yearsList"></div>
          <div class="note">Definition of "rainy": daily precipitation ‚â• selected threshold. Units: millimeters (mm), inches shown in parentheses.</div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <h2 style="margin-top:0">About this MVP</h2>
      <p class="note">This tool fetches daily precipitation for a range of years and counts how many target dates met the rain threshold. Data is from the Open‚ÄëMeteo Archive API (ERA5‚ÄëLand, 10 km grid). For exact station observations (e.g., SNOTEL), you can integrate additional sources later.</p>
    </section>
  </div>

  <script>
    // Populate month/day selects
    const monthSel = document.getElementById('month');
    const daySel = document.getElementById('day');
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    monthNames.forEach((m,i)=>{
      const opt = document.createElement('option');
      opt.value = String(i+1).padStart(2,'0');
      opt.textContent = `${opt.value} ‚Äî ${m}`;
      monthSel.appendChild(opt);
    });
    monthSel.value = '07';

    function repopulateDays() {
      const year = 2024; // any leap ref
      const month = parseInt(monthSel.value, 10)-1;
      const daysInMonth = new Date(year, month+1, 0).getDate();
      daySel.innerHTML = '';
      for (let d=1; d<=daysInMonth; d++) {
        const opt = document.createElement('option');
        opt.value = String(d).padStart(2,'0');
        opt.textContent = opt.value;
        daySel.appendChild(opt);
      }
      if (parseInt(monthSel.value,10) === 7) daySel.value = '25';
    }
    monthSel.addEventListener('change', repopulateDays);
    repopulateDays();

    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const yearsListEl = document.getElementById('yearsList');
    const kpiCount = document.getElementById('kpiCount');
    const kpiPct = document.getElementById('kpiPct');
    const kpiAvg = document.getElementById('kpiAvg');

    const pickerEl = document.getElementById('picker');
    const candidateSelect = document.getElementById('candidateSelect');
    const useCandidateBtn = document.getElementById('useCandidate');

    const biasUS = document.getElementById('biasUS');
    const biasUtah = document.getElementById('biasUtah');

    function mmToIn(mm) { return mm / 25.4; }

    const ALIASES = {
      'snowbird': 'Snowbird, Utah, USA',
      'snowbird, utah': 'Snowbird, Utah, USA',
      'alta': 'Alta, Utah, USA',
      'park city': 'Park City, Utah, USA',
      'deer valley': 'Deer Valley, Utah, USA'
    };

    async function geocodeMulti(query) {
      // Try aliases first for common ski areas
      const key = query.trim().toLowerCase();
      if (ALIASES[key]) query = ALIASES[key];

      const url = new URL('https://geocoding-api.open-meteo.com/v1/search');
      url.searchParams.set('name', query);
      url.searchParams.set('count', '10');
      url.searchParams.set('language', 'en');

      const res = await fetch(url);
      if (!res.ok) throw new Error('Geocoding failed');
      const data = await res.json();
      let results = data.results || [];

      // If nothing found and user didn't specify country/state, try sensible fallbacks
      if (results.length === 0) {
        const trials = [
          query + ', Utah',
          query + ', Utah, USA',
          query + ' Ski Resort, Utah, USA'
        ];
        for (const t of trials) {
          const u = new URL('https://geocoding-api.open-meteo.com/v1/search');
          u.searchParams.set('name', t);
          u.searchParams.set('count', '10');
          u.searchParams.set('language', 'en');
          const r2 = await fetch(u);
          if (r2.ok) {
            const d2 = await r2.json();
            if (d2.results && d2.results.length) { results = d2.results; break; }
          }
        }
      }

      // Optional biases
      if (biasUS.checked) {
        results = results.filter(r => r.country_code === 'US');
      }
      if (biasUtah.checked) {
        const utahOnes = results.filter(r => (r.admin1 || '').toLowerCase().includes('utah'));
        if (utahOnes.length) results = utahOnes;
      }
      return results;
    }

    function showCandidatePicker(list) {
      candidateSelect.innerHTML = '';
      list.forEach((r, idx) => {
        const opt = document.createElement('option');
        const parts = [r.name, r.admin1, r.country].filter(Boolean).join(', ');
        opt.value = String(idx);
        opt.textContent = parts + `  (lat ${r.latitude.toFixed(3)}, lon ${r.longitude.toFixed(3)})`;
        candidateSelect.appendChild(opt);
      });
      pickerEl.style.display = 'block';
    }

    function hideCandidatePicker() {
      pickerEl.style.display = 'none';
    }

    function lastCompleteYears(n) {
      const endYear = new Date().getFullYear() - 1; // exclude incomplete current year
      const startYear = endYear - (n - 1);
      return { startYear, endYear };
    }

    function buildArchiveURL(lat, lon, start, end) {
      const url = new URL('https://archive-api.open-meteo.com/v1/archive');
      url.searchParams.set('latitude', lat);
      url.searchParams.set('longitude', lon);
      url.searchParams.set('start_date', start);
      url.searchParams.set('end_date', end);
      url.searchParams.set('daily', 'precipitation_sum');
      url.searchParams.set('timezone', 'auto');
      return url.toString();
    }

    async function run(query, month, day, nYears, thresholdMm) {
      resultsEl.style.display = 'none';
      hideCandidatePicker();
      statusEl.textContent = 'Looking up coordinates‚Ä¶';
      try {
        const candidates = await geocodeMulti(query);
        if (!candidates || candidates.length === 0) {
          throw new Error('No matching location found. Try adding state/country (e.g., "Alta, Utah").');
        }

        // If more than one, ask user to pick
        let chosen = candidates[0];
        if (candidates.length > 1) {
          showCandidatePicker(candidates);
          statusEl.textContent = 'Multiple locations found ‚Äî pick one.';
          await new Promise((resolve) => {
            useCandidateBtn.onclick = () => {
              const idx = parseInt(candidateSelect.value, 10) || 0;
              chosen = candidates[idx];
              hideCandidatePicker();
              resolve();
            };
          });
        }

        const loc = { lat: chosen.latitude, lon: chosen.longitude, name: [chosen.name, chosen.admin1, chosen.country].filter(Boolean).join(', ') };
        statusEl.textContent = `Using ${loc.name}. Fetching historical daily precipitation‚Ä¶`;

        const { startYear, endYear } = lastCompleteYears(nYears);
        const start = `${startYear}-${month}-01`;
        const end = `${endYear}-${month}-31`;
        const url = buildArchiveURL(loc.lat, loc.lon, start, end);

        const res = await fetch(url);
        if (!res.ok) throw new Error('Archive API request failed');
        const data = await res.json();
        if (!data.daily || !data.daily.time) throw new Error('No daily data returned');

        const times = data.daily.time; // YYYY-MM-DD strings
        const prec = data.daily.precipitation_sum; // mm

        const targetMD = `-${month}-${day}`; // e.g., -07-25
        const records = [];
        for (let i=0; i<times.length; i++) {
          if (times[i].endsWith(targetMD)) {
            const y = parseInt(times[i].slice(0,4), 10);
            if (y >= startYear && y <= endYear) {
              records.push({ year: y, mm: prec[i] ?? 0 });
            }
          }
        }

        if (records.length === 0) throw new Error('No matching date records found.');

        const rainy = records.filter(r => (r.mm || 0) >= thresholdMm);
        const count = rainy.length;
        const pct = (count / records.length) * 100;
        const avgOnRainy = rainy.length ? (rainy.reduce((a,b)=>a+b.mm,0) / rainy.length) : 0;

        // Update UI
        kpiCount.textContent = `${count} / ${records.length}`;
        kpiPct.textContent = `${pct.toFixed(0)}%`;
        kpiAvg.textContent = `${avgOnRainy.toFixed(2)} mm (${mmToIn(avgOnRainy).toFixed(2)} in)`;

        const lines = records.map(r => {
          const mark = (r.mm >= thresholdMm) ? '‚òî' : '¬∑';
          const ins = mmToIn(r.mm).toFixed(2);
          const mm = r.mm.toFixed(2);
          return `${mark} ${r.year}: ${mm} mm (${ins} in)`;
        });
        yearsListEl.textContent = lines.join('\n');

        statusEl.innerHTML = `<span class="ok">Done:</span> ${loc.name} ‚Ä¢ ${month}/${day} ‚Ä¢ ${startYear}‚Äì${endYear} ‚Ä¢ threshold ‚â• ${thresholdMm} mm`;
        resultsEl.style.display = 'grid';
      } catch (err) {
        statusEl.innerHTML = `<span class="err">${err.message}</span>`;
        resultsEl.style.display = 'none';
      }
    }

    document.getElementById('go').addEventListener('click', () => {
      const q = document.getElementById('place').value.trim();
      const m = monthSel.value;
      const d = daySel.value;
      const n = Math.max(5, Math.min(70, parseInt(document.getElementById('years').value, 10) || 20));
      const threshold = parseFloat(document.getElementById('threshold').value);
      run(q, m, d, n, threshold);
    });

    document.getElementById('demo').addEventListener('click', () => {
      document.getElementById('place').value = 'Snowbird';
      monthSel.value = '07'; repopulateDays(); daySel.value = '25';
      document.getElementById('years').value = '20';
      document.getElementById('threshold').value = '0.1';
      biasUS.checked = true; biasUtah.checked = true;
      document.getElementById('go').click();
    });
  </script>
</body>
</html>
